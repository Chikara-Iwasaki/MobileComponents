(function(m,g,t){var u=this,x=u.Force,e=this.Force={};e.noConflict=function(){u.Force=x;return this};var j=function(a,c,b){return function(){var d=m.makeArray(arguments),k=m.Deferred();d.push(function(){console.log("------\x3e Calling successCB for "+b+":"+c);try{k.resolve.apply(k,arguments)}catch(a){console.error("------\x3e Error when calling successCB for "+b+":"+c),console.error(a.stack)}});d.push(function(){console.log("------\x3e Calling errorCB for "+b+":"+c);try{k.reject.apply(k,arguments)}catch(a){console.error("------\x3e Error when calling errorCB for "+
b+":"+c),console.error(a.stack)}});console.log("-----\x3e Calling "+b+":"+c);a[c].apply(a,d);return k.promise()}},h=null,f=null,y=function(a){a=a||"";var c=a.indexOf("SalesforceMobileSDK"),c=a.indexOf("Hybrid",c);return 0>c?a+" EntityFramework":a.substring(0,c)+"Hybrid EntityFramework"+a.substring(c+6)};e.init=function(a,c){c=c||"v27.0";var b=new forcetk.Client(a.clientId,a.loginUrl);b.setSessionToken(a.accessToken,c,a.instanceUrl);b.setRefreshToken(a.refreshToken);b.setUserAgentString(y(a.userAgent));
h={};h.create=j(b,"create","forcetkClient");h.retrieve=j(b,"retrieve","forcetkClient");h.update=j(b,"update","forcetkClient");h.del=j(b,"del","forcetkClient");h.query=j(b,"query","forcetkClient");h.queryMore=j(b,"queryMore","forcetkClient");h.search=j(b,"search","forcetkClient");h.metadata=j(b,"metadata","forcetkClient");h.describe=j(b,"describe","forcetkClient");e.forcetkClient=h;navigator.smartstore&&(f={},f.registerSoup=j(navigator.smartstore,"registerSoup","smartstoreClient"),f.upsertSoupEntriesWithExternalId=
j(navigator.smartstore,"upsertSoupEntriesWithExternalId","smartstoreClient"),f.querySoup=j(navigator.smartstore,"querySoup","smartstoreClient"),f.runSmartQuery=j(navigator.smartstore,"runSmartQuery","smartstoreClient"),f.moveCursorToNextPage=j(navigator.smartstore,"moveCursorToNextPage","smartstoreClient"),f.removeFromSoup=j(navigator.smartstore,"removeFromSoup","smartstoreClient"),f.closeCursor=j(navigator.smartstore,"closeCursor","smartstoreClient"),f.soupExists=j(navigator.smartstore,"soupExists",
"smartstoreClient"),f.removeSoup=j(navigator.smartstore,"removeSoup","smartstoreClient"),f.retrieveSoupEntries=j(navigator.smartstore,"retrieveSoupEntries","smartstoreClient"),e.smartstoreClient=f)};e.Error=function(a){if(g.has(a,"responseText")){this.type="RestError";this.xhr=a;this.status=a.status;try{this.details=JSON.parse(a.responseText)}catch(c){console.log("Could not parse responseText:"+c)}}else g.has(a,"conflict")&&(this.type="ConflictError",g.extend(this,a))};e.StoreCache=function(a,c,b){this.soupName=
a;this.keyField=b||"Id";this.additionalIndexSpecs=c||[]};g.extend(e.StoreCache.prototype,{init:function(){if(null!=f){var a=g.union([{path:this.keyField,type:"string"},{path:"__local__",type:"string"}],this.additionalIndexSpecs);return f.registerSoup(this.soupName,a)}},retrieve:function(a,c){if(null!=this.soupName){var b=this,d=navigator.smartstore.buildExactQuerySpec(this.keyField,a),k=null;return f.querySoup(this.soupName,d).then(function(a){1==a.currentPageOrderedEntries.length&&(k=a.currentPageOrderedEntries[0]);
return f.closeCursor(a)}).then(function(){null!=k&&(null!=c&&g.any(c,function(a){a:{var b=k;a=a.split(".");for(var c=0;c<a.length;c++){var d=a[c];if(!g.has(b,d)){a=!1;break a}b=b[d]}a=!0}return!a}))&&(console.log("----\x3e In StoreCache:retrieve "+b.soupName+":"+a+":in cache but missing some fields"),k=null);console.log("----\x3e In StoreCache:retrieve "+b.soupName+":"+a+":"+(null==k?"miss":"hit"));return k})}},save:function(a){if(null!=this.soupName){console.log("----\x3e In StoreCache:save "+this.soupName+
":"+a[this.keyField]);var c=this;a=this.addLocalFields(a);return this.retrieve(a[this.keyField]).then(function(b){a=g.extend(b||{},a);return f.upsertSoupEntriesWithExternalId(c.soupName,[a],c.keyField)}).then(function(a){return a[0]})}},saveAll:function(a){if(null!=this.soupName){console.log("----\x3e In StoreCache:saveAll records.length="+a.length);var c=this,b={},d="SELECT {"+this.soupName+":_soup} FROM {"+this.soupName+"} WHERE {"+this.soupName+":"+this.keyField+"} IN ('"+g.pluck(a,this.keyField).join("','")+
"')",d=navigator.smartstore.buildSmartQuerySpec(d,a.length);return f.runSmartQuery(d).then(function(a){g.each(a.currentPageOrderedEntries,function(a){b[a[c.keyField]]=a});return f.closeCursor(a)}).then(function(){a=g.map(a,function(a){return c.addLocalFields(g.extend(b[a[c.keyField]]||{},a))});return f.upsertSoupEntriesWithExternalId(c.soupName,a,c.keyField)})}},find:function(a){var c=function(a){return a.currentPageIndex+1==a.totalPages?f.closeCursor(a).then(function(){return a}):a};return f.querySoup(this.soupName,
a).then(c).then(function(a){return{records:a.currentPageOrderedEntries,hasMore:function(){return null!=a&&a.currentPageIndex+1<a.totalPages},getMore:function(){var d=this;if(d.hasMore())return f.moveCursorToNextPage(a).then(c).then(function(c){a=c;d.records=g.union(d.records,a.currentPageOrderedEntries);return a.currentPageOrderedEntries})},closeCursor:function(){return f.closeCursor(a).then(function(){a=null})}}})},remove:function(a){if(null!=this.soupName){console.log("----\x3e In StoreCache:remove "+
this.soupName+":"+a);var c=this;a=navigator.smartstore.buildExactQuerySpec(this.keyField,a);var b=null;return f.querySoup(this.soupName,a).then(function(a){1==a.currentPageOrderedEntries.length&&(b=a.currentPageOrderedEntries[0]._soupEntryId);return f.closeCursor(a)}).then(function(){return null!=b?f.removeFromSoup(c.soupName,[b]):null}).then(function(){return null})}},makeLocalId:function(){return g.uniqueId("local_"+(new Date).getTime())},isLocalId:function(a){return null!=a&&0==a.indexOf("local_")},
addLocalFields:function(a){a=g.extend({__locally_created__:!1,__locally_updated__:!1,__locally_deleted__:!1},a);a.__local__=a.__locally_created__||a.__locally_updated__||a.__locally_deleted__;return a}});e.SObjectType=function(a,c){this.sobjectType=a;this.cache=c};g.extend(e.SObjectType.prototype,function(){var a,c=!1,b=function(){if(a.cache)return a.cache.retrieve(a.sobjectType).then(function(b){b&&(c=null!=b,a._describeResult=b.describeResult,a._metadataResult=b.metadataResult)})},d=function(){if(!c&&
a.cache){var b={describeResult:a._describeResult,metadataResult:a._metadataResult};b[a.cache.keyField]=a.sobjectType;return a.cache.save(b)}},k=function(){if(a.cache)return a.cache.remove(a.sobjectType)},g=function(){if(!a._describeResult)return c=!1,h.describe(a.sobjectType).then(function(b){a._describeResult=b})},e=function(){if(!a._metadataResult)return c=!1,h.metadata(a.sobjectType).then(function(b){a._metadataResult=b})};return{describe:function(){a=this;return a._describeResult?m.when(a._describeResult):
m.when(b()).then(g).then(d).then(function(){return a._describeResult})},getMetadata:function(){a=this;return a._metadataResult?m.when(a._metadataResult):m.when(b()).then(e).then(d).then(function(){return a._metadataResult})},reset:function(){a=this;c=!1;a._metadataResult=a._describeResult=void 0;return m.when(k())}}}());e.syncSObjectWithCache=function(a,c,b,d,k,e,n){console.log("---\x3e In Force.syncSObjectWithCache:method="+a+" id="+b);n=n||!1;c=e.isLocalId(b);var f=null;switch(a){case "create":a=
g.extend(d,{Id:n?e.makeLocalId():b,__locally_created__:n,__locally_updated__:!1,__locally_deleted__:!1});f=e.save(a);break;case "read":f=e.retrieve(b,k).then(function(a){return a});break;case "update":a=g.extend(d,{Id:b,__locally_created__:c,__locally_updated__:n,__locally_deleted__:!1});f=e.save(a);break;case "delete":f=!n||c?e.remove(b):e.retrieve(b).then(function(a){return e.save(g.extend(a,{__locally_deleted__:!0}))}).then(function(){return null})}return f};e.syncSObjectWithServer=function(a,
c,b,d,e,f,n){console.log("---\x3e In Force.syncSObjectWithServer:method="+a+" id="+b);var z=function(a){return h.retrieve(c,a.Id,n)},l=null;switch(a){case "create":b=g.pick(d,e);l=h.create(c,g.omit(b,"Id")).then(function(a){return g.extend(d,{Id:a.id})});break;case "read":l=h.retrieve(c,b,e);break;case "update":a=g.pick(d,e);l=h.update(c,b,g.omit(a,"Id")).then(function(){return d});break;case "delete":l=h.del(c,b).then(function(){return null})}f&&(l=l.then(z));return l};e.CACHE_MODE={CACHE_ONLY:"cache-only",
CACHE_FIRST:"cache-first",SERVER_ONLY:"server-only",SERVER_FIRST:"server-first"};e.syncSObject=function(a,c,b,d,g,f,n,h,l){console.log("--\x3e In Force.syncSObject:method="+a+" id="+b+" cacheMode="+l);var j=function(a,b){return e.syncSObjectWithServer(a,c,b,d,g,f,n)};if(null==h||l==e.CACHE_MODE.SERVER_ONLY)return j(a,b);if(null!=h&&l==e.CACHE_MODE.CACHE_ONLY)return e.syncSObjectWithCache(a,c,b,d,null,h,!0);var p=null,m=!1;if(l==e.CACHE_MODE.CACHE_FIRST)p=e.syncSObjectWithCache(a,c,b,d,g,h,void 0).then(function(c){m=
null!=c;return!m?j(a,b):c});else if(l==e.CACHE_MODE.SERVER_FIRST||null==l)if(h.isLocalId(b)){if("read"==a||"delete"==a)throw Error("Can't "+a+" on server a locally created record");var s,p=j("create",null).then(function(a){s=a;return e.syncSObjectWithCache("delete",c,b,void 0,void 0,h,void 0)}).then(function(){return s})}else p=j(a,b);return p=p.then(function(d){return!m?e.syncSObjectWithCache("read"==a?"update":a,c,"delete"==a?b:d.Id,d,void 0,h,void 0):d})};e.MERGE_MODE={OVERWRITE:"overwrite",MERGE_ACCEPT_YOURS:"merge-accept-yours",
MERGE_FAIL_IF_CONFLICT:"merge-fail-if-conflict",MERGE_FAIL_IF_CHANGED:"merge-fail-if-changed"};e.syncSObjectDetectConflict=function(a,c,b,d,k,f,n,j,l,q,p){console.log("--\x3e In Force.syncSObjectDetectConflict:method="+a+" id="+b+" cacheMode="+l+" mergeMode="+p);var r=function(d){return e.syncSObject(a,c,b,d,k,f,n,j,l)};if(null==q)return r(d);var s=function(a){return l==e.CACHE_MODE.CACHE_ONLY||a.__local__?a:q.save(a)},t=function(){return l==e.CACHE_MODE.CACHE_ONLY?null:q.remove(b)},w=function(a,
b){return g.filter(g.intersection(k,g.union(g.keys(a),g.keys(b))),function(c){return(a[c]||"")!=(b[c]||"")})},u=function(){var a;return p==e.MERGE_MODE.OVERWRITE||null==p||l==e.CACHE_MODE.CACHE_ONLY||null!=j&&j.isLocalId(b)?r(d):q.retrieve(b).then(function(d){a=d;return null==a?null:h.retrieve(c,b,k||["Id"])}).then(function(b){var c=!1;if(null==b||null==a)return r(d);var f=w(a,d),k=w(d,b),h=w(a,b),k=g.intersection(h,f,k),j=g.difference(h,k);switch(p){case e.MERGE_MODE.MERGE_ACCEPT_YOURS:c=!1;break;
case e.MERGE_MODE.MERGE_FAIL_IF_CONFLICT:c=0<k.length;break;case e.MERGE_MODE.MERGE_FAIL_IF_CHANGED:c=0<h.length}if(c)return b={conflict:!0,base:a,theirs:b,yours:d,remoteChanges:h,localChanges:f,conflictingChanges:k},m.Deferred().reject(b);b=g.extend(d,g.pick(b,j));return r(b)})},v=null;switch(a){case "create":v=r(d).then(s);break;case "read":v=r(d).then(s);break;case "update":v=u().then(s);break;case "delete":v=u().then(t)}return v};e.fetchSObjectsFromCache=function(a,c){console.log("---\x3e In Force.fetchSObjectsFromCache");
return a.find(c)};e.fetchSObjectsFromServer=function(a){console.log("---\x3e In Force.fetchSObjectsFromServer:config="+JSON.stringify(a));var c=function(a){return h.query(a).then(function(a){var b=a.nextRecordsUrl;return{totalSize:a.totalSize,records:a.records,hasMore:function(){return null!=b},getMore:function(){var a=this;return!b?null:h.queryMore(b).then(function(c){b=c.nextRecordsUrl;a.records.pushObjects(c.records);return c.records})},closeCursor:function(){return m.when(function(){b=null})}}})},
b=null;switch(a.type){case "soql":b=c(a.query);break;case "sosl":b=h.search(a.query).then(function(a){return{records:a,totalSize:a.length,hasMore:function(){return!1}}});break;case "mru":var d=a.sobjectType,e=a.fieldlist,b=h.metadata(d).then(function(a){return e?(a="SELECT "+e.join(",")+" FROM "+d+" WHERE Id IN ('"+g.pluck(a.recentItems,"Id").join("','")+"')",c(a)):{records:a.recentItems,totalSize:a.recentItems.length,hasMore:function(){return!1}}})}return b};e.fetchSObjects=function(a,c,b){console.log("--\x3e In Force.fetchSObjects:config.type="+
a.type);if(null!=c&&"cache"==a.type)a=e.fetchSObjectsFromCache(c,a.cacheQuery);else if(a=e.fetchSObjectsFromServer(a),null!=c){var d,f=function(a){return c.saveAll(a)},h=function(a){return null!=b?cacheForOriginal.saveAll(a):a};a=a.then(function(a){d=a;return a.records}).then(f).then(h).then(function(a){return g.extend(d,{records:a,getMore:function(){return d.getMore().then(f).then(h)}})})}return a};g.isUndefined(t)||(e.SObject=t.Model.extend({fieldlist:null,cacheMode:null,mergeMode:null,cache:null,
cacheForOriginals:null,refetch:null,refetchFieldList:null,sobjectType:null,idAttribute:"Id",sync:function(a,c,b){var d=this,f=function(c){return b[c]||(g.isFunction(d[c])?d[c](a):d[c])};console.log("-> In Force.SObject:sync method="+a+" model.id="+c.id);var h=f("fieldlist"),j=f("cacheMode"),m=f("mergeMode"),l=f("cache"),q=f("cacheForOriginals");f("refetch");f("refetchFieldList");e.syncSObjectDetectConflict(a,this.sobjectType,c.id,c.attributes,h,b.refetch,b.refetchFieldList,l,j,q,m).done(b.success).fail(b.error)}}),
e.SObjectCollection=t.Collection.extend({cache:null,cacheForOriginals:null,config:null,hasMore:function(){return this._fetchResponse?this._fetchResponse.hasMore():!1},getMore:function(){var a=this;if(a.hasMore())return a._fetchResponse.getMore().then(function(c){a.set(c);return c});m.when([])},closeCursor:function(){return m.when(!this.hasMore()||that._fetchResponse.closeCursor())},sync:function(a,c,b){console.log("-> In Force.SObjectCollection:sync method="+a);var d=this;if("read"!=a)throw Error("Method "+
a+" not supported");var f=b.config||(g.isFunction(this.config)?this.config():this.config);a=b.cache||(g.isFunction(this.cache)?this.cache():this.cache);c=b.cacheForOriginals||(g.isFunction(this.cacheForOriginals)?this.cacheForOriginals():this.cacheForOriginals);null==f?b.success([]):(b.reset=!0,e.fetchSObjects(f,a,c).then(function(a){d._fetchResponse=a;d.set(a.records);f.closeCursorImmediate&&d.closeCursor();return a.records}).done(b.success).fail(b.error))},parse:function(a){var c=this;return g.map(a,
function(a){var d=a.attributes.type;a=new c.model(a);a.sobjectType=d;return a})}}))}).call(this,$,_,window.Backbone);