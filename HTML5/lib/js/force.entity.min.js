(function(m,g,p){var q=this,r=q.Force,f=this.Force={};f.noConflict=function(){q.Force=r;return this};var k=function(a,c,b){return function(){var d=m.makeArray(arguments),l=m.Deferred();d.push(function(){console.log("------\x3e Calling successCB for "+b+":"+c);l.resolve.apply(l,arguments)});d.push(function(){console.log("------\x3e Calling errorCB for "+b+":"+c);l.reject.apply(l,arguments)});console.log("-----\x3e Calling "+b+":"+c);a[c].apply(a,d);return l.promise()}},h=null,e=null;f.init=function(a,
c){c=c||"v27.0";var b=new forcetk.Client(a.clientId,a.loginUrl);b.setSessionToken(a.accessToken,c,a.instanceUrl);b.setRefreshToken(a.refreshToken);b.setUserAgentString(a.userAgent);h={};h.create=k(b,"create","forcetkClient");h.retrieve=k(b,"retrieve","forcetkClient");h.update=k(b,"update","forcetkClient");h.del=k(b,"del","forcetkClient");h.query=k(b,"query","forcetkClient");h.queryMore=k(b,"queryMore","forcetkClient");h.search=k(b,"search","forcetkClient");h.metadata=k(b,"metadata","forcetkClient");
h.describe=k(b,"describe","forcetkClient");navigator.smartstore&&(e={},e.registerSoup=k(navigator.smartstore,"registerSoup","smartstoreClient"),e.upsertSoupEntriesWithExternalId=k(navigator.smartstore,"upsertSoupEntriesWithExternalId","smartstoreClient"),e.querySoup=k(navigator.smartstore,"querySoup","smartstoreClient"),e.moveCursorToNextPage=k(navigator.smartstore,"moveCursorToNextPage","smartstoreClient"),e.removeFromSoup=k(navigator.smartstore,"removeFromSoup","smartstoreClient"),e.closeCursor=
k(navigator.smartstore,"closeCursor","smartstoreClient"))};f.RestError=function(a){this.xhr=a;this.status=a.status;try{this.details=JSON.parse(a.responseText)}catch(c){console.log("Could not parse responseText:"+c)}};f.StoreCache=function(a,c,b){this.soupName=a;this.keyField=b||"Id";this.additionalIndexSpecs=c};g.extend(f.StoreCache.prototype,{init:function(){if(null!=e){var a=g.union([{path:this.keyField,type:"string"},{path:"__local__",type:"string"}],this.additionalIndexSpecs);return e.registerSoup(this.soupName,
a)}},retrieve:function(a,c){if(null!=this.soupName){var b=navigator.smartstore.buildExactQuerySpec(this.keyField,a),d=null;return e.querySoup(this.soupName,b).then(function(a){1==a.currentPageOrderedEntries.length&&(d=a.currentPageOrderedEntries[0]);return e.closeCursor(a)}).then(function(){null!=d&&(null!=c&&g.any(c,function(a){return!g.has(d,a)}))&&(console.log("----\x3e In StoreCache:retrieve "+a+":in cache but missing some fields"),d=null);console.log("----\x3e In StoreCache:retrieve "+a+":"+
(null==d?"miss":"hit"));return d})}},save:function(a){if(null!=this.soupName)return console.log("----\x3e In StoreCache:save "+a[this.keyField]),a.__local__=a.__locally_created__||a.__locally_updated__||a.__locally_deleted__,e.upsertSoupEntriesWithExternalId(this.soupName,[a],this.keyField)},saveAll:function(a){if(null!=this.soupName)return console.log("----\x3e In StoreCache:saveAll records.length="+a.length),a=g.map(a,function(a){a.__local__=a.__locally_created__||a.__locally_updated__||a.__locally_deleted__;
return a}),e.upsertSoupEntriesWithExternalId(this.soupName,a,this.keyField)},find:function(a){var c=function(a){var c=m.when(a);return a.currentPageIndex+1==a.totalPages?e.closeCursor(a).then(c):c};return e.querySoup(this.soupName,a).then(c).then(function(a){return{records:a.currentPageOrderedEntries,hasMore:function(){return null!=a&&a.currentPageIndex+1<a.totalPages},getMore:function(){var d=this;if(d.hasMore())return e.moveCursorToNextPage(a).then(c).then(function(c){a=c;d.records.pushObjects(a.currentPageOrderedEntries);
return a.currentPageOrderedEntries})},closeCursor:function(){return e.closeCursor(a).then(function(){a=null})}}})},remove:function(a){if(null!=this.soupName){console.log("----\x3e In StoreCache:remove "+a);var c=this;a=navigator.smartstore.buildExactQuerySpec(this.keyField,a);var b=null;return e.querySoup(this.soupName,a).then(function(a){1==a.currentPageOrderedEntries.length&&(b=a.currentPageOrderedEntries[0]._soupEntryId);return e.closeCursor(a)}).then(function(){return null!=b?e.removeFromSoup(c.soupName,
[b]):null}).then(function(){return null})}},makeLocalId:function(){return g.uniqueId("local_"+(new Date).getTime())},isLocalId:function(a){return null!=a&&0==a.indexOf("local_")}});f.SObjectType=function(a,c){this.sobjectType=a;this.cache=c};g.extend(f.SObjectType.prototype,function(){var a,c=function(){if(a.cache)return a.cache.retrieve(a.sobjectType).then(function(b){b&&(a._describeResult=b.describeResult,a._metadataResult=b.metadataResult)})},b=function(){if(a.cache){var b={describeResult:a._describeResult,
metadataResult:a._metadataResult};b[a.cache.keyField]=a.sobjectType;return a.cache.save(b)}},d=function(){if(!a._describeResult)return h.describe(a.sobjectType).then(function(b){a._describeResult=b})},l=function(){if(!a._metadataResult)return h.metadata(a.sobjectType).then(function(b){a._metadataResult=b})};return{describe:function(){a=this;return a._describeResult?m.when(a._describeResult):m.when(c()).then(d).then(b).then(function(){return a._describeResult})},getMetadata:function(){a=this;return a._metadataResult?
m.when(a._metadataResult):m.when(c()).then(l).then(b).then(function(){return a._metadataResult})},reset:function(){a=this;a._metadataResult=a._describeResult=void 0;return m.when(clearCache())}}}());f.syncSObjectWithCache=function(a,c,b,d,l,n,f){console.log("---\x3e In Force.syncSObjectWithCache:method="+a+" id="+b);f=f||!1;c=n.isLocalId(b);var j=null;switch(a){case "create":var h=g.extend(d,{Id:f?n.makeLocalId():b,__locally_created__:f,__locally_updated__:!1,__locally_deleted__:!1}),j=n.save(h).then(function(){return h});
break;case "read":j=n.retrieve(b,l).then(function(a){return a});break;case "update":var e=g.extend(d,{Id:b,__locally_created__:c,__locally_updated__:f,__locally_deleted__:!1}),j=n.save(e).then(function(){return e});break;case "delete":j=!f||c?n.remove(b):n.retrieve(b).then(function(a){return n.save(g.extend(a,{__locally_deleted__:!0}))}).then(function(){return null})}return j};f.syncSObjectWithServer=function(a,c,b,d,f,n){console.log("---\x3e In Force.syncSObjectWithServer:method="+a+" id="+b);var e=
function(){return h.retrieve(c,b,f)},j=null;switch(a){case "create":a=g.pick(d,f);j=h.create(c,g.omit(a,"Id")).then(function(a){return g.extend(d,{Id:a.id})});break;case "read":j=e();break;case "update":a=g.pick(d,f);j=h.update(c,b,g.omit(a,"Id")).then(function(){return d});break;case "delete":j=h.del(c,b).then(function(){return null})}n&&(j=j.then(e));return j};f.syncSObject=function(a,c,b,d,l,n,e,j){console.log("--\x3e In Force.syncSObject:method="+a+" id="+b+" cacheMode="+j);var g=function(a,b){return f.syncSObjectWithServer(a,
c,b,d,l,n)};if(null==e||"server-only"==j)return g(a,b);if(null!=e&&"cache-only"==j)return f.syncSObjectWithCache(a,c,b,d,l,e,!0);var h=null,k=!1;if("cache-first"==j)h=f.syncSObjectWithCache(a,c,b,d,l,e,void 0).then(function(c){k=null!=c;return!k?g(a,b):c});else if("server-first"==j||null==j)if(e.isLocalId(b)){if("read"==a||"delete"==a)throw"Can't "+a+" on server a locally created record";var m,h=g("create",null).then(function(a){m=a;return f.syncSObjectWithCache("delete",c,b,void 0,l,e,void 0)}).then(function(){return m})}else h=
g(a,b);return h=h.then(function(d){return!k?f.syncSObjectWithCache("read"==a?"update":a,c,"delete"==a?b:d.Id,d,l,e,void 0):d})};f.fetchSObjectsFromCache=function(a,c){console.log("---\x3e In Force.fetchSObjectsFromCache");return a.find(c)};f.saveSObjectsInCache=function(a,c){console.log("---\x3e In Force.saveSObjectsInCache");var b=g.map(c,function(a){return g.extend(a,{__locally_created__:!1,__locally_updated__:!1,__locally_deleted__:!1})});return a.saveAll(b)};f.fetchSObjectsFromServer=function(a){console.log("---\x3e In Force.fetchSObjectsFromServer:config="+
JSON.stringify(a));var c=function(a){return h.query(a).then(function(a){var b=a.nextRecordsUrl;return{totalSize:a.totalSize,records:a.records,hasMore:function(){return null!=b},getMore:function(){var a=this;return!b?null:h.queryMore(b).then(function(c){b=c.nextRecordsUrl;a.records.pushObjects(c.records);return c.records})},closeCursor:function(){return m.when(function(){b=null})}}})},b=null;switch(a.type){case "soql":b=c(a.query);break;case "sosl":b=h.search(a.query).then(function(a){return{records:a.searchRecords.records,
totalSize:a.searchRecords.records.length,hasMore:function(){return!1}}});break;case "mru":var d=a.sobjectType,f=a.fieldlist,b=h.metadata(d).then(function(a){return f?(a="SELECT "+f.join(",")+" FROM "+d+" WHERE Id IN ('"+g.pluck(a.recentItems,"Id").join("','")+"')",c(a)):{records:a.recentItems,totalSize:a.recentItems.length,hasMore:function(){return!1}}})}return b};f.fetchSObjects=function(a,c){console.log("--\x3e In Force.fetchSObjects:config.type="+a.type);var b;if(null!=c&&"cache"==a.type)b=f.fetchSObjectsFromCache(c,
a.cacheQuery);else if(b=f.fetchSObjectsFromServer(a),null!=c){var d,e=function(a){return f.saveSObjectsInCache(c,a).then(function(){return a})};b=b.then(function(a){d=a;return a.records}).then(e).then(function(){return g.extend({},d,{getMore:function(){return d.getMore().then(e)}})})}return b};g.isUndefined(p)||(f.SObject=p.Model.extend({fieldlist:null,cacheMode:null,sobjectType:null,idAttribute:"Id",getClass:function(){return this.__proto__.constructor},sync:function(a,c,b){console.log("-> In Force.SObject:sync method="+
a+" model.id="+c.id);var d=b.fieldlist||(g.isFunction(this.fieldlist)?this.fieldlist(a):this.fieldlist),e=b.cacheMode||(g.isFunction(this.cacheMode)?this.cacheMode(a):this.cacheMode);f.syncSObject(a,this.sobjectType,c.id,c.attributes,d,b.refetch,this.getClass().cache,e).done(b.success).fail(b.error)}},{cache:null,setupCache:function(a){this.cache=a}}),f.SObjectCollection=p.Collection.extend({config:null,getClass:function(){return this.__proto__.constructor},hasMore:function(){return this._fetchResponse?
this._fetchResponse.hasMore():!1},getMore:function(){var a=this;if(a.hasMore())return a._fetchResponse.getMore().then(function(c){a.set(c);return c});m.when([])},closeCursor:function(){return m.when(!this.hasMore()||that._fetchResponse.closeCursor())},sync:function(a,c,b){console.log("-> In Force.SObjectCollection:sync method="+a);var d=this;if("read"!=a)throw"Method "+a+" not supported";var e=b.config||(g.isFunction(this.config)?this.config():this.config);null==e?b.success([]):(b.reset=!0,f.fetchSObjects(e,
this.getClass().cache).then(function(a){d._fetchResponse=a;d.set(a.records);e.closeCursorImmediate&&d.closeCursor();return a.records}).done(b.success).fail(b.error))},parse:function(a){var c=this;return g.map(a,function(a){var d=a.attributes.type;a=new c.model(a);a.sobjectType=d;return a})}},{cache:null,setupCache:function(a){this.cache=a}}))}).call(this,$,_,window.Backbone);